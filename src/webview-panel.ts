import * as vscode from "vscode";

import { COMMAND, MESSAGE, NAME, TYPE } from "./constants";
import {
  generateResponseObject,
  getBody,
  getExtensionConfig,
  getHeaders,
  getNonce,
  getUrl,
} from "./utils";
import { IRequestHeaderInformation, IRequestObjectType } from "./utils/type";
import RequestHistoryProvider from "./request-history";
import CollectionsProvider from "./collections";

class MainWebviewPanel {
  private url: string = "";
  private body: string | FormData | URLSearchParams = "";
  private method: string = "";
  private headers: IRequestHeaderInformation = { key: "" };
  public mainPanel: vscode.WebviewPanel | null = null;
  private collectionName: string | undefined;
  private requestName: string | undefined;
  private extensionUri;
  private requestHistoryProvider;
  private collectionsProvider;

  constructor(
    extensionUri: vscode.Uri,
    requestHistoryProvider: RequestHistoryProvider,
    collectionsProvider: CollectionsProvider,
  ) {
    this.extensionUri = extensionUri;
    this.requestHistoryProvider = requestHistoryProvider;
    this.collectionsProvider = collectionsProvider;
  }

  initializeWebview(collectionName?: string, requestName?: string) {
    this.collectionName = collectionName;
    this.requestName = requestName;

    this.mainPanel = vscode.window.createWebviewPanel(
      TYPE.WEBVIEW_TYPE,
      requestName || NAME.MAIN_PANEL_NAME,
      vscode.ViewColumn.One,
      {
        enableScripts: true,
        retainContextWhenHidden: true,
        localResourceRoots: [
          vscode.Uri.joinPath(this.extensionUri, "media"),
          vscode.Uri.joinPath(this.extensionUri, "dist"),
        ],
      },
    );

    this.mainPanel.webview.html = this.getHtmlForWebview(
      this.mainPanel.webview,
    );

    this.mainPanel.iconPath = vscode.Uri.joinPath(
      this.extensionUri,
      "icons/images/apitester-icon.png",
    );

    this.receiveWebviewMessage();

    return this.mainPanel;
  }

  private receiveWebviewMessage() {
    if (!this.mainPanel) {
      return;
    }

    this.mainPanel.webview.onDidReceiveMessage(
      ({ requestMethod, requestUrl, authOption, authData, bodyOption, bodyRawOption, bodyRawData, keyValueTableData, command }) => {
        if (command === COMMAND.ALERT_COPY) {
          vscode.window.showInformationMessage(MESSAGE.COPY_SUCCESFUL_MESSAGE);
          return;
        }

        if (command === COMMAND.INIT_CONFIG) {
          const configObject = {
            type: COMMAND.HAS_CONFIG,
            config: JSON.stringify(getExtensionConfig())
          };

          if (this.mainPanel) {
            this.mainPanel.webview.postMessage(configObject);
          }
          return;
        }

        if (requestUrl.length === 0) {
          vscode.window.showWarningMessage(MESSAGE.WARNING_MESSAGE);
          return;
        }

        const requestObject = {
          requestMethod,
          requestUrl,
          authOption,
          authData,
          bodyOption,
          bodyRawOption,
          bodyRawData,
          keyValueTableData,
          command,
        };

        this.url = getUrl(requestUrl);
        this.method = requestMethod;
        this.headers = getHeaders(keyValueTableData, authOption, authData);

        // @ts-expect-error
        this.body = getBody(
          keyValueTableData,
          bodyOption,
          bodyRawOption,
          bodyRawData
        );

        this.postWebviewMessage(requestObject);
      },
    );
  }

  private async postWebviewMessage(requestObject: IRequestObjectType) {
    const requestData = {
      url: this.url,
      method: this.method,
      headers: this.headers,
      data: this.body,
      responseType: TYPE.TEXT
    };

    const responseObject = await generateResponseObject(requestData);
    const requestedTime = new Date().getTime();

    if (responseObject && responseObject.type !== MESSAGE.ERROR) {
      if (this.mainPanel) {
        this.mainPanel.webview.postMessage(responseObject);

        if (this.collectionName && this.requestName) {
          this.collectionsProvider.add(this.collectionName, {
            ...requestData,
            requestedTime,
            id: crypto.randomUUID(),
            name: this.requestName,
            requestObject,
          });
        } else {
          this.requestHistoryProvider.add({
            ...requestData,
            requestedTime,
            id: crypto.randomUUID(),
            name: "",
            requestObject,
          });
        }
      }
    }
  }

  private getHtmlForWebview(panel: vscode.Webview) {
    const scriptPath = vscode.Uri.joinPath(
      this.extensionUri,
      "dist",
      "bundle.js",
    );
    const resetCssPath = vscode.Uri.joinPath(
      this.extensionUri,
      "media",
      "reset.css",
    );
    const vscodeStylesCssPath = vscode.Uri.joinPath(
      this.extensionUri,
      "media",
      "vscode.css",
    );

    const resetCssSrc = panel.asWebviewUri(resetCssPath);
    const mainStylesCssSrc = panel.asWebviewUri(vscodeStylesCssPath);
    const scriptSrc = panel.asWebviewUri(scriptPath);
    const nonce = getNonce();

    return `
      <!DOCTYPE html>
      <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>API Tester</title>
          <link href="${resetCssSrc}" rel="stylesheet">
          <link href="${mainStylesCssSrc}" rel="stylesheet">
        </head>
        <body>
          <div id="root"></div>
          <script nonce="${nonce}">
            const vscode = acquireVsCodeApi();
          </script>
          <script src="${scriptSrc}" nonce="${nonce}"></script>
        </body>
      </html>
    `;
  }
}

export default MainWebviewPanel;